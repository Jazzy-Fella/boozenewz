<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booze Newz</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet" />
</head>
<body class="crt">

  <!-- CEEFAX‐style header with live time -->
  <div class="teletext-header">
    <span class="page">P100</span>
    <span class="ceefax-block">CEEFAX 1 420</span>
    <span class="datetime" id="datetime">--:--:--</span>
  </div>

  <!-- Title, Beer Guy, and Filters -->
  <div class="title-section">
    <div class="title-inner logo">
      <img src="img/beer-man.png" alt="Beer Guy" class="beer-icon" />
      <h1>BOOZE NEWZ</h1>
    </div>
    <!-- Supermarket filters -->
    <div class="filter-buttons">
      <button class="active" id="filter-all">All</button>
      <button id="filter-tesco">Tesco</button>
      <button id="filter-morrisons">Morrisons</button>
      <button id="filter-asda">Asda</button>
    </div>
    <!-- Category filters -->
    <div class="filter-buttons">
      <button class="active" id="filter-cat-all">All</button>
      <button id="filter-cat-beer">Beer</button>
      <button id="filter-cat-spirits">Spirits</button>
    </div>
  </div>

  <!-- Deals table -->
  <div class="table-container">
    <table id="deals-table">
      <thead>
        <tr>
          <th>Product Link</th>
          <th>Price</th>
          <th>Promo Price</th>
          <th>Saving</th>
        </tr>
      </thead>
      <tbody id="deals-body">
        <!-- rows injected by JS -->
        <!-- sentinel will go here -->
      </tbody>
    </table>
  </div>

  <!-- Live datetime updater -->
  <script>
    function updateTime() {
      const now = new Date();
      const d = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][now.getDay()];
      const m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][now.getMonth()];
      const two = n => String(n).padStart(2,'0');
      document.getElementById('datetime').textContent =
        `${d} ${two(now.getDate())} ${m} ${two(now.getHours())}:${two(now.getMinutes())}:${two(now.getSeconds())}`;
    }
    setInterval(updateTime, 1000);
    updateTime();
  </script>

  <!-- Filtering logic -->
  <script>
    const storeBtns = {
      all:       document.getElementById('filter-all'),
      tesco:     document.getElementById('filter-tesco'),
      morrisons: document.getElementById('filter-morrisons'),
      asda:      document.getElementById('filter-asda'),
    };
    const catBtns = {
      all:     document.getElementById('filter-cat-all'),
      beer:    document.getElementById('filter-cat-beer'),
      spirits: document.getElementById('filter-cat-spirits'),
    };
    let currentStore = '';
    let currentCat   = '';
    function applyFilters() {
      document.querySelectorAll('#deals-table tbody tr.row-data').forEach(row => {
        const byStore = !currentStore   || row.dataset.store === currentStore;
        const byCat   = !currentCat     || row.dataset.category === currentCat;
        row.style.display = (byStore && byCat) ? '' : 'none';
      });
    }
    Object.entries(storeBtns).forEach(([key, btn]) => {
      btn.addEventListener('click', () => {
        Object.values(storeBtns).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentStore = (key === 'all' ? '' : key);
        applyFilters();
      });
    });
    Object.entries(catBtns).forEach(([key, btn]) => {
      btn.addEventListener('click', () => {
        Object.values(catBtns).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCat = (key === 'all' ? '' : key);
        applyFilters();
      });
    });
  </script>

  <!-- Lazy‐load + ASDA “was X” + dynamic saving -->
  <script>
    fetch('deals.json')
      .then(r => r.json())
      .then(data => {
        const tbody    = document.getElementById('deals-body');
        const batch    = 100;
        let   idx      = 0;

        // create sentinel row
        const sentinel = document.createElement('tr');
        sentinel.id = 'lazy-sentinel';
        const td = document.createElement('td');
        td.colSpan = 4;
        td.style.textAlign = 'center';
        td.style.padding = '12px';
        td.textContent = 'Loading more…';
        sentinel.appendChild(td);
        tbody.appendChild(sentinel);

        function loadBatch() {
          const end = Math.min(idx + batch, data.length);
          for (; idx < end; idx++) {
            const deal = data[idx];
            const tr = document.createElement('tr');
            tr.classList.add('row-data');

            // Product Link
            const p = document.createElement('td');
            p.classList.add('product-link');
            const a = document.createElement('a');
            a.href = deal.link; a.textContent = deal.title; a.target = '_blank';
            p.appendChild(a);
            tr.appendChild(p);

            // ASDA was‑swap
            let priceText = deal.price;
            let promoText = deal.promotion || '';
            if (deal.store.toLowerCase()==='asda' && promoText.trim().toLowerCase().startsWith('was')) {
              const orig = promoText.replace(/^was\s*/i,'').trim();
              priceText = orig; promoText = deal.price;
            }

            // Price & Promo Price
            const priceTd = document.createElement('td');
            priceTd.classList.add('price'); priceTd.textContent = priceText;
            tr.appendChild(priceTd);
            const promoTd = document.createElement('td');
            promoTd.classList.add('promotion'); promoTd.textContent = promoText;
            tr.appendChild(promoTd);

            // dynamic saving
            let saving = deal.saving;
            if (deal.store.toLowerCase()==='asda' && (deal.promotion||'').trim().toLowerCase().startsWith('was')) {
              const o = parseFloat(priceText.replace(/[^0-9.]/g,'')),
                    n = parseFloat(deal.price.replace(/[^0-9.]/g,''));
              saving = o - n;
            }
            const sTd = document.createElement('td');
            sTd.classList.add('saving');
            sTd.textContent = (!isNaN(saving)) ? `£${saving.toFixed(2)}` : '';
            tr.appendChild(sTd);

            // data‑attrs for filters
            tr.dataset.store    = deal.store.toLowerCase();
            tr.dataset.category = (deal.category||'').toLowerCase();

            tbody.insertBefore(tr, sentinel);
          }
          if (idx >= data.length) {
            observer.disconnect();
            sentinel.remove();
          }
          applyFilters();
        }

        // intersection observer
        const observer = new IntersectionObserver(entries => {
          if (entries[0].isIntersecting) loadBatch();
        }, { rootMargin: '200px' });
        observer.observe(sentinel);

      })
      .catch(console.error);
  </script>

</body>
</html>
